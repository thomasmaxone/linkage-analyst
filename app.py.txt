# app.py
# Streamlit App: Linkage Analyst (Similar to Analyst Notebook)
# Save this file as app.py and run with: streamlit run app.py
# Author: Grok for user tomstewart545-dot

import streamlit as st
import networkx as nx
import plotly.graph_objects as go
import pandas as pd
from io import StringIO

st.set_page_config(page_title="Linkage Analyst", layout="wide")
st.title("üîó Linkage Analyst")
st.markdown("""
A simple Analyst Notebook-inspired tool for entity-relationship visualization.
- Upload CSV files for **Nodes** and **Edges**.
- Or use the **manual editors** to add data.
- Visualize linkages with interactive force-directed graph.
- Drag nodes, zoom, hover for details.
""")

# --- Sidebar for Instructions & Examples ---
with st.sidebar:
    st.header("üìã How to Use")
    st.markdown("""
1. **Prepare Data**:
   - **Nodes CSV**: Columns `id` (unique), `label` (display name), optional `type` (e.g., Person, Org), `details`.
   - **Edges CSV**: Columns `source` (node id), `target` (node id), optional `relation`, `weight`.

2. **Upload or Edit**:
   - Use file uploaders **or** editable dataframes.

3. **Visualize**:
   - Click **Refresh Graph** after changes.

4. **Export**:
   - Download current graph as PNG (via Plotly).
""")

    st.header("üìÑ Example CSVs")
    example_nodes = """id,label,type,details
1,Alice,Person,Analyst
2,Bob,Person,Manager
3,CompanyX,Org,Tech Firm
4,ProjectY,Project,Secret"""
    example_edges = """source,target,relation,weight
1,2,Reports To,1
1,3,Works At,1
2,4,Leads,2
3,4,Funds,3"""

    st.download_button("Download Example Nodes CSV", example_nodes, "example_nodes.csv", "text/csv")
    st.download_button("Download Example Edges CSV", example_edges, "example_edges.csv", "text/csv")

# --- Tabs for Input Methods ---
tab_upload, tab_manual = st.tabs(["üìÇ Upload CSVs", "‚úçÔ∏è Manual Edit"])

# --- Upload Tab ---
with tab_upload:
    col1, col2 = st.columns(2)
    with col1:
        uploaded_nodes = st.file_uploader("Upload Nodes CSV", type=["csv"], key="nodes_upload")
    with col2:
        uploaded_edges = st.file_uploader("Upload Edges CSV", type=["csv"], key="edges_upload")

# --- Manual Edit Tab ---
with tab_manual:
    st.markdown("### Nodes (add/edit rows below)")
    default_nodes_df = pd.DataFrame([
        {"id": "1", "label": "Alice", "type": "Person", "details": "Analyst"},
        {"id": "2", "label": "Bob", "type": "Person", "details": "Manager"},
    ])
    nodes_df = st.data_editor(
        default_nodes_df if (tab_upload and not uploaded_nodes) else pd.DataFrame(columns=["id", "label", "type", "details"]),
        num_rows="dynamic",
        use_container_width=True,
        key="nodes_editor"
    )

    st.markdown("### Edges (add/edit rows below)")
    default_edges_df = pd.DataFrame([
        {"source": "1", "target": "2", "relation": "Reports To", "weight": 1},
    ])
    edges_df = st.data_editor(
        default_edges_df if (tab_upload and not uploaded_edges) else pd.DataFrame(columns=["source", "target", "relation", "weight"]),
        num_rows="dynamic",
        use_container_width=True,
        key="edges_editor"
    )

# --- Load Data Logic ---
def load_csv(uploaded_file):
    if uploaded_file is not None:
        return pd.read_csv(uploaded_file)
    return None

nodes_csv = load_csv(uploaded_nodes)
edges_csv = load_csv(uploaded_edges)

# Prioritize manual editor if used, otherwise uploaded CSVs
if 'nodes_editor' in st.session_state and not nodes_df.empty:
    nodes = nodes_df
elif nodes_csv is not None:
    nodes = nodes_csv
else:
    nodes = pd.DataFrame()

if 'edges_editor' in st.session_state and not edges_df.empty:
    edges = edges_df
elif edges_csv is not None:
    edges = edges_csv
else:
    edges = pd.DataFrame()

# --- Validation ---
valid = True
if nodes.empty:
    st.warning("‚ö†Ô∏è No nodes defined. Add via upload or manual editor.")
    valid = False
if edges.empty:
    st.info("‚ÑπÔ∏è No edges defined. Graph will show isolated nodes.")
else:
    # Check edge references
    node_ids = set(nodes["id"].astype(str))
    invalid_sources = edges[~edges["source"].astype(str).isin(node_ids)]["source"]
    invalid_targets = edges[~edges["target"].astype(str).isin(node_ids)]["target"]
    if not invalid_sources.empty or not invalid_targets.empty:
        st.error(f"Invalid links: sources {list(invalid_sources.unique())}, targets {list(invalid_targets.unique())} not in nodes.")
        valid = False

# --- Build Graph ---
if valid and st.button("üîÑ Refresh Graph", type="primary"):
    G = nx.Graph()

    # Add nodes
    for _, row in nodes.iterrows():
        node_id = str(row["id"])
        label = row.get("label", node_id)
        node_type = row.get("type", "Unknown")
        details = row.get("details", "")
        G.add_node(node_id, label=label, type=node_type, details=details)

    # Add edges
    for _, row in edges.iterrows():
        src = str(row["source"])
        tgt = str(row["target"])
        relation = row.get("relation", "Linked")
        weight = float(row.get("weight", 1))
        G.add_edge(src, tgt, relation=relation, weight=weight)

    # --- Compute Layout (Force-Directed) ---
    pos = nx.spring_layout(G, k=2, iterations=50, seed=42)

    # --- Prepare Plotly Traces ---
    edge_x = []
    edge_y = []
    edge_text = []
    for edge in G.edges(data=True):
        x0, y0 = pos[edge[0]]
        x1, y1 = pos[edge[1]]
        edge_x.extend([x0, x1, None])
        edge_y.extend([y0, y1, None])
        edge_text.append(f"{edge[2].get('relation', 'Link')}<br>Weight: {edge[2].get('weight', 1)}")

    edge_trace = go.Scatter(
        x=edge_x, y=edge_y,
        line=dict(width=1, color="#888"),
        hoverinfo="text",
# app.py - Linkage Analyst PRO (Beautiful Web App Look)
# Deploy at: https://yourname-linkage.streamlit.app

import streamlit as st
import networkx as nx
import plotly.graph_objects as go
import pandas as pd

# =========================== PAGE CONFIG & STYLE ===========================
st.set_page_config(
    page_title="Linkage Analyst PRO",
    page_icon="üîó",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS - Makes it look like a real web app
st.markdown("""
<style>
    .main > div {padding-top: 2rem;}
    .css-1d391kg {padding-top: 1rem;}
    .stPlotlyChart {background: #0e1117; border-radius: 12px; padding: 10px;}
    .title-text {font-size: 3rem !important; font-weight: 800; background: linear-gradient(90deg, #00C9FF, #92FE9D); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
    .header-bar {background: #1a1a2e; padding: 1rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3);}
    .card {background: #16213e; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); margin: 1rem 0;}
    .stDataEditor {background: #0f111a; border-radius: 10px;}
    .footer {text-align: center; padding: 2rem; color: #666; font-size: 0.9rem; margin-top: 4rem;}
</style>
""", unsafe_allow_html=True)

# =========================== HEADER ===========================
col1, col2 = st.columns([1, 6])
with col1:
    st.markdown("### üîó")
with col2:
    st.markdown('<h1 class="title-text">Linkage Analyst PRO</h1>', unsafe_allow_html=True)
    st.markdown("**Entity-Relationship Intelligence Platform** ‚Ä¢ OSINT ‚Ä¢ Investigations ‚Ä¢ Network Mapping")

st.markdown("---")

# =========================== SIDEBAR BRANDING ===========================
with st.sidebar:
    st.image("https://img.icons8.com/clouds/200/000000/link.png", width=150)
    st.markdown("<h2 style='text-align:center; color:#00C9FF;'>Linkage Analyst</h2>", unsafe_allow_html=True)
    st.markdown("<p style='text-align:center; color:#888;'>v2.0 ‚Ä¢ Professional Edition</p>", unsafe_allow_html=True)
    st.markdown("---")
    st.markdown("### üìä Quick Start")
    st.info("1. Add nodes & edges\n2. Click **Refresh Graph**\n3. Drag ‚Ä¢ Zoom ‚Ä¢ Export")
    st.markdown("### üé® Features")
    st.success("‚Ä¢ Dark Professional Theme\n‚Ä¢ Force-Directed Layout\n‚Ä¢ Hover Details\n‚Ä¢ PNG Export\n‚Ä¢ Live Editing")

# =========================== TABS ===========================
tab1, tab2, tab3 = st.tabs(["üìà Graph View", "üìù Data Input", "‚ÑπÔ∏è Help & Export"])

with tab1:
    st.markdown("<div class='card'>", unsafe_allow_html=True)
    graph_placeholder = st.empty()
    st.markdown("</div>", unsafe_allow_html=True)

with tab2:
    st.markdown("<div class='card'>", unsafe_allow_html=True)
    subtab_nodes, subtab_edges = st.tabs(["Nodes", "Edges"])

    with subtab_nodes:
        st.markdown("#### Entities / People / Organizations")
        nodes_df = st.data_editor(
            st.session_state.get("nodes_df", pd.DataFrame(columns=["id", "label", "type", "details"])),
            num_rows="dynamic",
            use_container_width=True,
            key="nodes_editor"
        )
        st.session_state.nodes_df = nodes_df

    with subtab_edges:
        st.markdown("#### Relationships / Connections")
        edges_df = st.data_editor(
            st.session_state.get("edges_df", pd.DataFrame(columns=["source", "target", "relation", "weight"])),
            num_rows="dynamic",
            use_container_width=True,
            key="edges_editor"
        )
        st.session_state.edges_df = edges_df
    st.markdown("</div>", unsafe_allow_html=True)

with tab3:
    st.markdown("<div class='card'>", unsafe_allow_html=True)
    st.markdown("### Example Data")
    example_nodes = """id,label,type,details
1,Alice Smith,Person,Lead Analyst
2,Bob Johnson,Person,Senior Manager
3,Acme Corp,Organization,Defense Contractor
4,Project Phoenix,Project,Classified R&D
5,David Lee,Person,Whistleblower"""
    example_edges = """source,target,relation,weight
1,2,Reports To,1
1,3,Works For,1
2,4,Directs,3
3,4,Funds,5
1,5,Contacted,2"""
    
    c1, c2 = st.columns(2)
    with c1:
        st.download_button("üì• Download Example Nodes", example_nodes, "example_nodes.csv")
    with c2:
        st.download_button("üì• Download Example Edges", example_edges, "example_edges.csv")
    
    st.markdown("### Export Current Graph")
    export_placeholder = st.empty()
    st.markdown("</div>", unsafe_allow_html=True)

# =========================== BUILD & DISPLAY GRAPH ===========================
if st.button("üîÑ Refresh Graph", type="primary", use_container_width=True):
    if 'nodes_df' not in st.session_state or st.session_state.nodes_df.empty:
        st.error("Add at least one node first!")
    else:
        G = nx.Graph()
        nodes = st.session_state.nodes_df
        edges = st.session_state.edges_df if 'edges_df' in st.session_state else pd.DataFrame()

        # Add nodes
        for _, row in nodes.iterrows():
            nid = str(row["id"])
            G.add_node(nid,
                       label=row.get("label", nid),
                       type=row.get("type", "Unknown"),
                       details=row.get("details", ""))

        # Add edges
        for _, row in edges.iterrows():
            src = str(row["source"])
            tgt = str(row["target"])
            if src in G.nodes and tgt in G.nodes:
                G.add_edge(src, tgt,
                           relation=row.get("relation", "Linked"),
                           weight=row.get("weight", 1))

        # Layout
        pos = nx.spring_layout(G, k=3, iterations=60, seed=42)

        # Edges
        edge_x, edge_y, edge_text = [], [], []
        for edge in G.edges(data=True):
            x0, y0 = pos[edge[0]]
            x1, y1 = pos[edge[1]]
            edge_x += [x0, x1, None]
            edge_y += [y0, y1, None]
            edge_text.append(f"<b>{edge[2].get('relation','Link')}</b><br>Weight: {edge[2].get('weight',1)}")

        edge_trace = go.Scatter(x=edge_x, y=edge_y, line=dict(width=2, color="#4a90e2"), hoverinfo="text", mode="lines", text=edge_text)

        # Nodes
        node_x, node_y, node_text, node_color = [], [], [], []
        color_map = {"Person": "#00C9FF", "Organization": "#92FE9D", "Project": "#FFB800", "Unknown": "#FF6B6B"}
        
        for node in G.nodes(data=True):
            x, y = pos[node[0]]
            node_x.append(x)
            node_y.append(y)
            info = node[1]
            node_text.append(f"<b>{info.get('label',node[0])}</b><br>Type: {info.get('type','?')}<br>{info.get('details','')}")
            node_color.append(color_map.get(info.get("type", "Unknown"), "#888"))

        node_trace = go.Scatter(
            x=node_x, y=node_y,
            mode="markers+text",
            hoverinfo="text",
            hovertext=node_text,
            text=[G.nodes[n].get("label", n) for n in G.nodes],
            textposition="top center",
            marker=dict(color=node_color, size=25, line=dict(width=3, color="#fff"))
        )

        fig = go.Figure(data=[edge_trace, node_trace],
                        layout=go.Layout(
                            title="",
                            showlegend=False,
                            hovermode="closest",
                            margin=dict(b=20,l=5,r=5,t=20),
                            xaxis=dict(showgrid=False, zeroline=False, showticklabels=False),
                            yaxis=dict(showgrid=False, zeroline=False, showticklabels=False),
                            paper_bgcolor="#0e1117",
                            plot_bgcolor="#0e1117",
                            height=750
                        ))

        with graph_placeholder:
            st.plotly_chart(fig, use_container_width=True, config={"displayModeBar": True})
        
        with export_placeholder:
            st.download_button(
                "üì∏ Download Graph as PNG (High-Res)",
                data=fig.to_image(format="png", width=1600, height=1000),
                file_name="linkage-analysis.png",
                mime="image/png"
            )

        # Stats
        st.sidebar.markdown("### üìà Network Stats")
        st.sidebar.metric("Nodes", G.number_of_nodes())
        st.sidebar.metric("Connections", G.number_of_edges())
        if G.number_of_nodes() > 0:
            central = max(dict(G.degree()), key=dict(G.degree()).get)
            st.sidebar.metric("Most Connected", G.nodes[central].get("label", central))

# =========================== FOOTER ===========================
st.markdown("<div class='footer'>"
            "Linkage Analyst PRO ‚Ä¢ Built for Australian OSINT & Investigations ‚Ä¢ "
            "Powered by Streamlit ‚Ä¢ Made for tom_stewart545@hotmail.com"
            "</div>", unsafe_allow_html=True)